name: Elixir CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  build:
    name: Build and test
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    
    - name: Install Nix
      uses: cachix/install-nix-action@v27
      with:
        nix_path: nixpkgs=channel:nixos-unstable
        extra_nix_config: |
          experimental-features = nix-command flakes
          access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Cachix
      uses: cachix/cachix-action@v15
      with:
        name: nix-community
        skipPush: true
    
    - name: Cache Mix dependencies
      uses: actions/cache@v4
      with:
        path: |
          deps
          _build/dev/lib
        key: ${{ runner.os }}-nix-mix-${{ hashFiles('mix.lock') }}
        restore-keys: |
          ${{ runner.os }}-nix-mix-
    
    - name: Cache Mix build artifacts
      uses: actions/cache@v4
      with:
        path: _build
        key: ${{ runner.os }}-nix-build-${{ hashFiles('mix.lock') }}-${{ hashFiles('lib/**/*.ex', 'test/**/*.exs', 'config/**/*.exs') }}
        restore-keys: |
          ${{ runner.os }}-nix-build-${{ hashFiles('mix.lock') }}-
          ${{ runner.os }}-nix-build-
    
    - name: Verify environment
      run: |
        nix develop --command bash -c "
          echo 'Elixir version:' && elixir --version
          echo 'Erlang version:' && erl -eval 'erlang:display(erlang:system_info(otp_release)), halt().' -noshell
          echo 'ab-av1 version:' && ab-av1 --version
          echo 'mediainfo version:' && mediainfo --version | head -1
          echo 'ffmpeg version:' && ffmpeg -version | head -1
        "
    
    - name: Install dependencies
      run: nix develop --command mix deps.get
    
    - name: Compile dependencies  
      run: nix develop --command mix deps.compile
    
    - name: Set test environment
      run: echo "MIX_ENV=test" >> $GITHUB_ENV
    
    - name: Compile project
      run: nix develop --command mix compile --warnings-as-errors
    
    - name: Check formatting
      run: nix develop --command mix format --check-formatted
    
    - name: Run Credo
      run: nix develop --command mix credo --strict
    
    - name: Run tests
      run: nix develop --command mix test
