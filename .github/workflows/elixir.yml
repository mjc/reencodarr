name: Elixir CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  build:
    name: Build and test
    runs-on: ubuntu-latest
    container:
      image: alpine:3.20
    
    env:
      MIX_ENV: test

    steps:
    - name: Install system dependencies
      run: |
        apk add --no-cache \
          git \
          bash \
          curl \
          build-base \
          openssl-dev \
          ncurses-dev \
          zlib-dev \
          ffmpeg \
          mediainfo

    - name: Install Erlang and Elixir
      run: |
        # Install Erlang 27 and Elixir 1.19 from Alpine edge
        apk add --no-cache --repository=https://dl-cdn.alpinelinux.org/alpine/edge/testing \
          erlang \
          elixir

    - name: Install ab-av1
      run: |
        # Install Rust and Cargo
        apk add --no-cache rust cargo
        # Install ab-av1 from source
        cargo install --git https://github.com/alexheretic/ab-av1.git ab-av1

    - uses: actions/checkout@v4
    
    - name: Cache Mix dependencies
      uses: actions/cache@v4
      with:
        path: |
          deps
          _build/test/lib
        key: ${{ runner.os }}-alpine-mix-${{ hashFiles('mix.lock') }}
        restore-keys: |
          ${{ runner.os }}-alpine-mix-
    
    - name: Cache Mix build artifacts
      uses: actions/cache@v4
      with:
        path: _build
        key: ${{ runner.os }}-alpine-build-${{ hashFiles('mix.lock') }}-${{ hashFiles('lib/**/*.ex', 'test/**/*.exs', 'config/**/*.exs') }}
        restore-keys: |
          ${{ runner.os }}-alpine-build-${{ hashFiles('mix.lock') }}-
          ${{ runner.os }}-alpine-build-

    - name: Verify environment
      run: |
        echo 'Elixir version:' && elixir --version
        echo 'Erlang version:' && erl -eval 'erlang:display(erlang:system_info(otp_release)), halt().' -noshell
        echo 'ab-av1 version:' && ab-av1 --version
        echo 'mediainfo version:' && mediainfo --version | head -1
        echo 'ffmpeg version:' && ffmpeg -version | head -1
    
    - name: Install dependencies
      run: mix deps.get
    
    - name: Compile dependencies  
      run: mix deps.compile
    
    - name: Compile project
      run: mix compile --warnings-as-errors
    
    - name: Check formatting
      run: mix format --check-formatted
    
    - name: Run Credo
      run: mix credo --strict
    
    - name: Run tests
      run: mix test
