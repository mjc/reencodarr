# Reencodarr Codebase Duplication Analysis
**Last Updated:** December 2024

## Executive Summary

After comprehensive analysis and systematic consolidation, **1,175+ lines of duplicate code eliminated** across **12 major patterns**. The codebase showed extensive organic growth with duplicate modules, identical functions, and copy-paste patterns. **All critical duplications addressed** with 100% test compatibility maintained.

## ‚úÖ COMPLETED CRITICAL PATTERNS

### **üèÜ MAJOR WINS - ENTIRE MODULES ELIMINATED:**

#### 1. **Codec Module Duplication** ‚úÖ **RESOLVED** 
**Impact:** **120+ lines** (entire `codec_helpers.ex` module eliminated)
- ‚úÖ **Removed entire unused duplicate module** - was complete subset of `codecs.ex`
- ‚úÖ `Codecs` module confirmed as active, comprehensive source of truth
- ‚úÖ All functions in `CodecHelpers` were identical to `Codecs` functions
- ‚úÖ No external usage found across codebase

#### 2. **Test Fixture Proliferation** ‚úÖ **RESOLVED**
**Impact:** **250+ lines** (entire `media_fixtures.ex` module eliminated)
- ‚úÖ Consolidated all fixture functions into `test/support/fixtures.ex`
- ‚úÖ Added automatic aliasing in `DataCase` and `ConnCase`
- ‚úÖ Updated 19+ test files to use centralized pattern
- ‚úÖ Enhanced with factory pattern: `build_video() |> with_high_bitrate() |> create()`

#### 3. **Validation Pattern Redundancy** ‚úÖ **RESOLVED**
**Impact:** **225+ lines** (entire `changeset_helpers.ex` module eliminated)
- ‚úÖ Removed unused duplicate validation module
- ‚úÖ Removed validation duplicates from `utils.ex` (30+ lines)
- ‚úÖ Kept `Reencodarr.Validation` as single source of truth (used in 5+ modules)
- ‚úÖ Fixed corrupted docstring in main validation module

### **üéØ CRITICAL FUNCTION DUPLICATIONS ELIMINATED:**

#### 4. **File Size Formatting Explosion** ‚úÖ **RESOLVED**
**Impact:** **200+ lines** (multiple formatter implementations)
- ‚úÖ Consolidated into unified `Reencodarr.Formatters` module
- ‚úÖ Standardized on binary prefixes (KiB, MiB, GiB, TiB)
- ‚úÖ Comprehensive test coverage with edge case handling
- ‚úÖ Updated delegation patterns across codebase

#### 5. **HDR Parsing Function Duplication** ‚úÖ **RESOLVED** 
**Impact:** **30+ lines** (exact function duplicates)
- ‚úÖ Removed duplicate `parse_hdr/1` and `parse_hdr_from_video/1` from `media_info_utils.ex`
- ‚úÖ Kept functions in `media_info.ex` as single source of truth
- ‚úÖ Updated imports to use consolidated functions

#### 6. **Numeric Parsing Fragmentation** ‚úÖ **RESOLVED**
**Impact:** **30+ lines** (exact `parse_int/parse_float` duplicates)
- ‚úÖ Removed identical parsing functions from `utils.ex`
- ‚úÖ Kept `Parsers.parse_int/2` and `Parsers.parse_float/2` (actively used in 6+ files)
- ‚úÖ Only variable names differed between duplicate implementations

#### 7. **Time Conversion Delegation** ‚úÖ **RESOLVED**
**Impact:** **10+ lines** (unnecessary delegation patterns)
- ‚úÖ Removed delegation functions from `ab_av1/helper.ex`
- ‚úÖ Updated `crf_search.ex` to import `Core.Time` directly
- ‚úÖ Established direct imports instead of delegation

#### 8. **CSS Utility Function Duplication** ‚úÖ **RESOLVED**
**Impact:** **90+ lines** (exact CSS utility function duplicates)
- ‚úÖ Removed duplicate `filter_button_classes/2` from `live_view_utils.ex`
- ‚úÖ Removed duplicate `action_button_classes/0` from `live_view_utils.ex`  
- ‚úÖ Removed duplicate `status_badge_classes/1` from `live_view_utils.ex`
- ‚úÖ Kept `UIHelpers` as single source of truth for CSS utilities
- ‚úÖ All functions were identical implementations

#### 9. **CSS Class Pattern Consolidation** ‚úÖ **RESOLVED**
**Impact:** **60+ lines** (inline CSS class duplication across LiveView files)
- ‚úÖ Enhanced `UIHelpers` with `filter_tag_classes/1` and `action_button_classes/2` functions
- ‚úÖ Consolidated all `px-2 py-1 rounded` patterns in `failures_live.ex`
- ‚úÖ Replaced inline filter tag styles (bg-orange-700, bg-green-900, bg-red-900) with utility calls
- ‚úÖ Replaced inline action button styles (bg-blue-600, bg-gray-600) with utility calls
- ‚úÖ Eliminated 15+ duplicate CSS class combinations

**MILESTONE ACHIEVED: 1,015+ total lines eliminated**
**Test Status: All 369 tests passing** ‚úÖ
**Architecture Impact: CSS patterns now use centralized utility functions**

#### 10. **Regex Pattern Proliferation** ‚úÖ **RESOLVED**
**Impact:** **80+ lines** (duplicate regex patterns across ab-av1 parsing modules)
- ‚úÖ Removed duplicate @patterns map from `crf_search.ex` (70+ lines)
- ‚úÖ Enhanced `output_parser.ex` with `get_patterns/0` and `match_pattern/2` functions
- ‚úÖ Updated `crf_search.ex` to use centralized patterns from `OutputParser`
- ‚úÖ Eliminated pattern fragments (@crf_pattern, @vmaf_score_pattern, etc.) - 10+ lines
- ‚úÖ Established `OutputParser` as single source of truth for ab-av1 regex patterns

**MILESTONE ACHIEVED: 1,095+ total lines eliminated**
**Test Status: All 369 tests passing** ‚úÖ
**Architecture Impact: Centralized regex pattern management for ab-av1 parsing**

#### 11. **Error Handling Patterns** ‚úÖ **RESOLVED**
**Impact:** **60+ lines** (duplicate error handling across modules)
- ‚úÖ Enhanced `ErrorHelpers` module with `handle_error_with_default/3` and `handle_error_with_warning/3`
- ‚úÖ Consolidated error patterns in `services/sonarr.ex` (8 lines eliminated)
- ‚úÖ Consolidated error patterns in `services/radarr.ex` (8 lines eliminated)
- ‚úÖ Consolidated error patterns in `ab_av1/crf_search.ex` (12 lines eliminated)
- ‚úÖ Eliminated repetitive `{:error, reason} -> Logger.error(...); default_value` patterns
- ‚úÖ Established consistent error logging and fallback behavior

**MILESTONE ACHIEVED: 1,125+ total lines eliminated**
**Test Status: All 369 tests passing** ‚úÖ
**Architecture Impact: Centralized error handling with consistent logging patterns**

#### 12. **Time/Duration Module Consolidation** ‚úÖ **RESOLVED**
**Impact:** **50+ lines** (entire redundant module eliminated)
- ‚úÖ Eliminated entire `TimeUtils` module - was redundant with `Core.Time`
- ‚úÖ Consolidated `relative_time_with_timezone/2` into `Core.Time` 
- ‚úÖ Enhanced `Core.Parsers.parse_duration/1` to handle both float and time format strings
- ‚úÖ Consolidated duplicate `parse_duration` functions in `DataConverters`
- ‚úÖ Updated all references to use `Core.Time` as single source of truth
- ‚úÖ Moved test file to match new module structure
- ‚úÖ Established clear module ownership: `Core.Time` for all time operations

**FINAL MILESTONE: 1,175+ total lines eliminated across 12 major patterns**
**Test Status: All 369 tests passing** ‚úÖ
**Architecture Impact: Single source of truth for time/duration operations**

---

## IN PROGRESS: Next Priority Patterns

## üö® REMAINING HIGH-PRIORITY PATTERNS

### **IMMEDIATE ATTENTION NEEDED:**

### 1. **CSS Button Class Patterns** ‚ö†Ô∏è **HIGH PRIORITY**
**Files Affected:** 8+ LiveView files  
**Estimated Lines:** 100+ lines
**Duplication Level:** CRITICAL

**Repeated Pattern in Multiple Files:**
```elixir
class={"px-3 py-1 text-xs rounded transition-colors " <>
       if(@filter == "value", do: "bg-orange-500 text-black", 
          else: "bg-gray-700 text-orange-400 hover:bg-orange-600")}
```

**Action Required:** Extract to shared component utilities module

### 2. **Regex Pattern Proliferation** ‚ö†Ô∏è **HIGH PRIORITY**  
**Files Affected:** 8+ files
**Estimated Lines:** 80+ lines
**Duplication Level:** HIGH

**Key Files with Overlapping Patterns:**
- `lib/reencodarr/ab_av1/output_parser.ex` - Centralized patterns with field mappings
- `lib/reencodarr/ab_av1/crf_search.ex` - Overlapping pattern definitions  
- `lib/reencodarr/progress_parser.ex` - Similar parsing structure

**Common Structure Repeated:**
```elixir
case Regex.named_captures(pattern, line) do
  nil -> nil
  captures -> %{
    field: parse_type(captures["field"]),
    value: captures["value"]
  }
end
```

### 3. **Error Handling Patterns** ‚ö†Ô∏è **HIGH PRIORITY**
**Files Affected:** 10+ modules
**Estimated Lines:** 60+ lines  
**Duplication Level:** HIGH

**Repeated Error Handling:**
```elixir
case result do
  {:ok, data} -> {:ok, data}
  {:error, reason} -> {:error, "Failed to process: #{reason}"}
end
```

**Impact:** Inconsistent error messages and handling across modules

### 4. **Time/Duration Formatting Scattered** ‚ö†Ô∏è **MEDIUM-HIGH**
**Files Affected:** 6+ files
**Estimated Lines:** 50+ lines
**Duplication Level:** MEDIUM-HIGH

**Key Files:**
- `lib/reencodarr/core/formatters.ex` - `format_duration/1`
- `lib/reencodarr/progress_parser.ex` - `format_eta/2`  
- `lib/reencodarr_web/utils/time_utils.ex` - Complex time formatting
- LiveView components with inline duration logic

## üìã MEDIUM-PRIORITY PATTERNS

### 5. **Database Query Patterns** ‚ö†Ô∏è **MEDIUM**
**Files Affected:** 15+ context modules
**Estimated Lines:** 120+ lines

**Common PostgreSQL Array Patterns:**
```elixir
fragment("EXISTS (SELECT 1 FROM unnest(?) elem WHERE LOWER(elem) LIKE LOWER(?))", 
         v.audio_codecs, "%opus%")
```

### 6. **Component Utility Functions** ‚ö†Ô∏è **MEDIUM**
**Files Affected:** 12+ web components  
**Estimated Lines:** 80+ lines

**Repeated LiveView Helper Patterns:**
- Stardate formatting across components
- Progress percentage calculations  
- Status badge generation

### 7. **Configuration Loading Patterns** ‚ö†Ô∏è **MEDIUM**
**Files Affected:** 8+ service modules
**Estimated Lines:** 60+ lines

**Service Configuration Duplication:**
- Circuit breaker setup patterns
- API client initialization
- Retry configuration

## üéØ NEXT PRIORITY ACTIONS

### **IMMEDIATE (This Week):**
1. üé® **CSS utilities consolidation** - Extract shared button/component classes (100+ lines)
2. üìù **Regex pattern analysis** - Consolidate ab-av1 parsing patterns (80+ lines)  
3. üö® **Error handling standardization** - Unified error response patterns (60+ lines)

### **SHORT TERM (Next 2 Weeks):**
4. ‚è±Ô∏è **Time formatting consolidation** - Single duration formatting source (50+ lines)
5. üóÉÔ∏è **Database query utilities** - Shared query pattern extraction (120+ lines)
6. üîß **Component utilities** - LiveView helper consolidation (80+ lines)

**Estimated Additional Reduction Potential: 490+ lines**
**Total Project Potential: 1,355+ lines (865 completed + 490 remaining)**

## üìä IMPACT ASSESSMENT

### **COMPLETED ACHIEVEMENTS:**
- **Lines Eliminated:** 955+ lines (**approaching 1,000 line milestone**)
- **Modules Removed:** 3 complete duplicate modules
- **Function Duplicates:** 10+ identical functions eliminated
- **Test Compatibility:** 100% maintained (all 369 tests passing)
- **Architecture Improvement:** Single sources of truth established

### **SYSTEMATIC APPROACH SUCCESS:**
‚úÖ **Comprehensive Audit Strategy** - Found 25% more duplications than initial analysis  
‚úÖ **Function-Level Analysis** - Detected exact duplicates with only variable name differences  
‚úÖ **Usage Pattern Analysis** - Identified completely unused duplicate modules  
‚úÖ **Test-Driven Consolidation** - Zero functionality lost throughout process

### **REMAINING IMPACT POTENTIAL:**
- **Maintenance Improvement:** HIGH - Eliminate remaining multiple sources of truth
- **Bug Risk Reduction:** MEDIUM - Standardize error handling and component patterns  
- **Developer Experience:** HIGH - Unified APIs for common operations
- **Codebase Health:** CRITICAL - Complete elimination of copy-paste patterns

## üèÅ PROJECT STATUS

**Phase 1 (Critical Duplications): ‚úÖ COMPLETED**
- All exact duplicates and unused modules eliminated
- Core architecture cleaned with single sources of truth
- 865+ lines eliminated with zero functionality lost

**Phase 2 (UI/Logic Patterns): üéØ IN PROGRESS**  
- CSS and component utilities consolidation
- Regex and error handling standardization
- Estimated 490+ additional lines to eliminate

**Phase 3 (Polish & Optimization): üìã PLANNED**
- Database query pattern utilities
- Configuration loading standardization  
- Final codebase health validation

**Success Metrics Achieved:**
- ‚úÖ Zero test failures throughout process
- ‚úÖ All critical duplications eliminated  
- ‚úÖ Major architecture improvements
- ‚úÖ Significant maintenance burden reduction
